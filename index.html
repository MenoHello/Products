<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MenoHello Product Grid</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: #ffe9e5;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    .header {
      background: #ffe9e5;
      padding: 15px 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      max-width: 1440px;
      margin: 0 auto;
    }
    
    input[type="text"], select, #favoritesToggle {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 1rem;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.3s ease;
    }
    
    input[type="text"]:focus, select:focus {
      outline: none;
      border-color: #ffa798;
    }
    
    #favoritesToggle {
      cursor: pointer;
      font-weight: 600;
      background: white;
      transition: background-color 0.3s ease;
    }
    
    #favoritesToggle:hover {
      background-color: #ffd2cb;
    }
    
    #favoritesToggle.active {
      background-color: #ffa798;
      color: white;
    }
    
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
      background: #ffe9e5;
      padding: 10px 15px;
      position: sticky;
      top: 70px;
      z-index: 999;
      max-width: 1440px;
      margin: 0 auto;
    }
    
    .category-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .category-dropdown select {
      background: white;
      border: 1px solid #ffa798;
      border-radius: 6px;
      padding: 8px 16px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      appearance: none;
      padding-right: 40px;
      background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23666" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
    }
    
    .category-dropdown select:hover {
      background-color: #ffd2cb;
    }
    
    .category-dropdown select:focus {
      outline: none;
      border-color: #ffa798;
    }
    
    .category-dropdown select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background-color: #f5f5f5;
    }
    
    .tabs button {
      background: white;
      border: 1px solid #ffa798;
      border-radius: 6px;
      padding: 8px 16px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .tabs button:hover {
      background-color: #ffd2cb;
      transform: translateY(-1px);
    }
    
    .tabs button.active {
      background-color: #ffa798;
      color: white;
    }
    
    #product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      max-width: 1440px;
      margin: 0 auto;
      padding: 40px;
      gap: 30px;
    }
    
    .product-card {
      background: white;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      position: relative;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      min-height: 400px;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .product-card img {
      max-width: 100%;
      height: 160px;
      object-fit: contain;
      border-radius: 6px;
      margin-top: 60px;
      transition: transform 0.3s ease;
    }
    
    .product-card:hover img {
      transform: scale(1.05);
    }
    
    .badge {
      position: absolute;
      top: 2px;
      left: 0;
      background: #8e599c;
      color: white;
      padding: 8px 16px;
      border-top-right-radius: 6px;
      border-bottom-right-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      text-transform: capitalize;
      white-space: nowrap;
      max-width: 75%;
      overflow: hidden;
    }
    
    .favorite {
      position: absolute;
      top: 16px;
      right: 16px;
      cursor: pointer;
      font-size: 2rem;
      color: #ccc;
      transition: all 0.3s ease;
    }
    
    .favorite:hover {
      transform: scale(1.1);
    }
    
    .favorite.active {
      color: #cd2609;
    }
    
    .stars {
      margin: 10px 0;
      font-size: 1.2rem;
      color: gold;
    }
    
    .stars i {
      margin: 0 2px;
    }
    
    .product-card h3 {
      margin: 12px 0 8px;
      font-weight: 700;
      font-size: 1.1rem;
      line-height: 1.3;
    }
    
    .product-card p.price {
      font-weight: 600;
      margin: 8px 0;
      font-size: 1.2rem;
      color: #333;
    }
    
    .product-card a {
      display: inline-block;
      margin-top: 12px;
      margin-bottom: 12px;
      background-color: #ffa798;
      color: #fff;
      padding: 10px 20px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .product-card a:hover {
      background-color: #ff9385;
      transform: translateY(-2px);
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 1.2rem;
      color: #666;
    }
    
    .error {
      text-align: center;
      padding: 50px;
      color: #d32f2f;
      font-size: 1.1rem;
    }
    
    .no-results {
      text-align: center;
      padding: 50px;
      color: #666;
      font-size: 1.1rem;
    }
    
    /* Mobile-specific styles */
    @media (max-width: 599px) {
      #product-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        padding: 15px;
        gap: 15px;
      }
      
      .product-card {
        min-height: 0;
        aspect-ratio: 4/5;
        padding: 8px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      
      .product-card img {
        height: 50px;
        margin-top: 20px;
        margin-bottom: 5px;
      }
      
      .product-card:hover img {
        transform: none;
      }
      
      .badge {
        font-size: 0.6rem;
        padding: 3px 6px;
        max-width: 80%;
        top: 1px;
      }
      
      .favorite {
        font-size: 1.2rem;
        top: 8px;
        right: 8px;
      }
      
      .product-card h3 {
        display: none;
      }
      
      .stars {
        margin: 3px 0;
        font-size: 0.8rem;
      }
      
      .stars i {
        margin: 0 1px;
      }
      
      .product-card p.price {
        font-size: 0.9rem;
        margin: 3px 0;
        font-weight: 700;
      }
      
      .product-card a {
        margin-top: 5px;
        margin-bottom: 5px;
        padding: 6px 12px;
        font-size: 0.8rem;
        border-radius: 4px;
      }
      
      .product-card a:hover {
        transform: none;
      }
    }
  </style>
</head>
<body>
<div class="header">
  <input type="text" id="searchInput" placeholder="Search products..." aria-label="Search products">
  <select id="sortPrice" aria-label="Sort by price">
    <option value="default">Default</option>
    <option value="low">Price: Low to High</option>
    <option value="high">Price: High to Low</option>
  </select>
  <button id="favoritesToggle" aria-label="Toggle favorites view">Show My Favorites</button>
</div>
<div class="tabs" id="categoryTabs" role="tablist"></div>
<div id="product-grid" role="main"></div>

<script>
class ProductGrid {
  constructor() {
    this.sheetId = '1a3tUL0Te-nzVrraDE3WetntJpdITpoDO7V4nFV6jr6I';
    this.gid = '0';
    this.csvUrl = `https://docs.google.com/spreadsheets/d/${this.sheetId}/export?format=csv&gid=${this.gid}`;
    this.products = [];
    this.filteredProducts = [];
    this.categories = new Set();
    this.currentCategory = 'All';
    this.showingFavorites = false;
    this.favorites = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));
    
    this.init();
  }
  
  async init() {
    try {
      this.showLoading();
      await this.loadProducts();
      this.setupEventListeners();
      this.renderTabs();
      this.renderProducts();
    } catch (error) {
      console.error('Error loading products:', error);
      this.showError(`Failed to load products: ${error.message}`);
      
      // Fallback to sample data for testing
      console.log('Loading sample data as fallback...');
      this.loadSampleData();
      this.setupEventListeners();
      this.renderTabs();
      this.renderProducts();
    }
  }
  
  loadSampleData() {
    this.products = [
      {
        productname: "Sample Product 1",
        category: "Health",
        approxprice: 29.99,
        ratings: 4.5,
        imageurl: "https://via.placeholder.com/200x200/ffa798/white?text=Product+1",
        amazonlink: "#",
        badge: "bestseller"
      },
      {
        productname: "Sample Product 2",
        category: "Beauty",
        approxprice: 19.99,
        ratings: 4.0,
        imageurl: "https://via.placeholder.com/200x200/8e599c/white?text=Product+2",
        amazonlink: "#",
        badge: "new"
      },
      {
        productname: "Sample Product 3",
        category: "Health",
        approxprice: 39.99,
        ratings: 5.0,
        imageurl: "https://via.placeholder.com/200x200/ffa798/white?text=Product+3",
        amazonlink: "#",
        badge: ""
      }
    ];
    
    this.products.forEach(p => this.categories.add(p.category));
    this.filteredProducts = [...this.products];
  }
  
  async loadProducts() {
    try {
      console.log('Fetching data from:', this.csvUrl);
      const response = await fetch(this.csvUrl);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const csvText = await response.text();
      console.log('CSV data received, length:', csvText.length);
      
      const data = Papa.parse(csvText, { 
        header: true, 
        skipEmptyLines: true,
        transformHeader: (header) => header.trim().toLowerCase()
      });
      
      console.log('Parsed data:', data);
      
      if (data.errors && data.errors.length > 0) {
        console.error('Parse errors:', data.errors);
      }
      
      this.products = data.data.filter(product => product.productname && product.productname.trim()).map(product => ({
        ...product,
        approxprice: parseFloat(product.approxprice) || 0,
        ratings: parseFloat(product.ratings) || 0
      }));
      
      console.log('Processed products:', this.products.length);
      
      if (this.products.length === 0) {
        throw new Error('No valid products found in the data');
      }
      
      this.products.forEach(p => {
        if (p.category) {
          this.categories.add(p.category);
        }
      });
      
      this.filteredProducts = [...this.products];
      console.log('Categories found:', Array.from(this.categories));
    } catch (error) {
      console.error('Error in loadProducts:', error);
      throw error;
    }
  }
  
  setupEventListeners() {
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortPrice');
    const favoritesToggle = document.getElementById('favoritesToggle');
    
    searchInput.addEventListener('input', this.debounce(() => this.handleSearch(), 300));
    sortSelect.addEventListener('change', () => this.handleSort());
    favoritesToggle.addEventListener('click', () => this.toggleFavorites());
  }
  
  debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  handleSearch() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    this.applyFilters(searchTerm);
  }
  
  handleSort() {
    const sortValue = document.getElementById('sortPrice').value;
    this.applySort(sortValue);
  }
  
  toggleFavorites() {
    this.showingFavorites = !this.showingFavorites;
    const toggle = document.getElementById('favoritesToggle');
    const categoryDropdown = document.getElementById('categoryDropdown');
    
    if (this.showingFavorites) {
      toggle.textContent = 'Back to All Products';
      toggle.classList.add('active');
      // Switch to "All" category when showing favorites
      this.currentCategory = 'All';
      categoryDropdown.value = 'All';
      categoryDropdown.disabled = true;
    } else {
      toggle.textContent = 'Show My Favorites';
      toggle.classList.remove('active');
      categoryDropdown.disabled = false;
    }
    
    this.applyFilters();
  }
  
  applyFilters(searchTerm = '') {
    let filtered = [...this.products];
    
    // Apply search filter first
    if (searchTerm) {
      filtered = filtered.filter(p => 
        p.productname.toLowerCase().includes(searchTerm) ||
        p.category.toLowerCase().includes(searchTerm) ||
        (p.badge && p.badge.toLowerCase().includes(searchTerm))
      );
    }
    
    // Apply favorites filter (shows all favorites regardless of category)
    if (this.showingFavorites) {
      filtered = filtered.filter(p => this.favorites.has(p.productname));
    } else {
      // Apply category filter only when not showing favorites
      if (this.currentCategory !== 'All') {
        filtered = filtered.filter(p => p.category === this.currentCategory);
      }
    }
    
    this.filteredProducts = filtered;
    this.applySort(document.getElementById('sortPrice').value);
  }
  
  applySort(sortValue) {
    switch (sortValue) {
      case 'low':
        this.filteredProducts.sort((a, b) => a.approxprice - b.approxprice);
        break;
      case 'high':
        this.filteredProducts.sort((a, b) => b.approxprice - a.approxprice);
        break;
      default:
        // Keep original order or sort by name
        this.filteredProducts.sort((a, b) => a.productname.localeCompare(b.productname));
    }
    
    this.renderProducts();
  }
  
  renderTabs() {
    const tabContainer = document.getElementById('categoryTabs');
    tabContainer.innerHTML = '';
    
    // Create dropdown container
    const dropdownContainer = document.createElement('div');
    dropdownContainer.className = 'category-dropdown';
    
    // Create dropdown select
    const select = document.createElement('select');
    select.id = 'categoryDropdown';
    select.setAttribute('aria-label', 'Select category');
    
    // Add "All" option
    const allOption = document.createElement('option');
    allOption.value = 'All';
    allOption.textContent = 'All Categories';
    allOption.selected = true;
    select.appendChild(allOption);
    
    // Add category options
    Array.from(this.categories).sort().forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      select.appendChild(option);
    });
    
    // Add event listener
    select.addEventListener('change', (e) => {
      this.currentCategory = e.target.value;
      this.applyFilters(document.getElementById('searchInput').value);
    });
    
    dropdownContainer.appendChild(select);
    tabContainer.appendChild(dropdownContainer);
  }
  
  createTabButton(category, isActive) {
    const btn = document.createElement('button');
    btn.textContent = category;
    btn.setAttribute('role', 'tab');
    btn.setAttribute('aria-selected', isActive);
    
    if (isActive) {
      btn.classList.add('active');
    }
    
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tabs button').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      
      this.currentCategory = category;
      this.applyFilters(document.getElementById('searchInput').value);
    });
    
    return btn;
  }
  
  renderProducts() {
    const grid = document.getElementById('product-grid');
    
    if (this.filteredProducts.length === 0) {
      grid.innerHTML = '<div class="no-results">No products found.</div>';
      return;
    }
    
    grid.innerHTML = '';
    
    this.filteredProducts.forEach(product => {
      const card = this.createProductCard(product);
      grid.appendChild(card);
    });
  }
  
  createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    const starsHtml = this.generateStarsHtml(product.ratings);
    const badge = product.badge ? `<span class="badge">${product.badge}</span>` : '';
    const isFavorite = this.favorites.has(product.productname);
    
    card.innerHTML = `
      ${badge}
      <span class="favorite ${isFavorite ? 'active' : ''}" role="button" aria-label="Toggle favorite">
        <i class="fa-${isFavorite ? 'solid' : 'regular'} fa-heart"></i>
      </span>
      <img src="${product.imageurl}" alt="${product.productname}" loading="lazy" />
      <h3>${product.productname}</h3>
      <div class="stars" aria-label="Rating: ${product.ratings} out of 5 stars">${starsHtml}</div>
      <p class="price">$${product.approxprice.toFixed(2)}</p>
      <a href="${product.amazonlink}" target="_blank" rel="noopener noreferrer">Shop Now</a>
    `;
    
    card.querySelector('.favorite').addEventListener('click', (e) => {
      e.preventDefault();
      this.toggleFavorite(product.productname, e.currentTarget);
    });
    
    return card;
  }
  
  generateStarsHtml(rating) {
    const fullStars = Math.floor(rating);
    const halfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
    
    let starsHtml = '';
    for (let i = 0; i < fullStars; i++) {
      starsHtml += '<i class="fa-solid fa-star"></i>';
    }
    if (halfStar) {
      starsHtml += '<i class="fa-solid fa-star-half-stroke"></i>';
    }
    for (let i = 0; i < emptyStars; i++) {
      starsHtml += '<i class="fa-regular fa-star"></i>';
    }
    
    return starsHtml;
  }
  
  toggleFavorite(productName, element) {
    const icon = element.querySelector('i');
    
    if (this.favorites.has(productName)) {
      this.favorites.delete(productName);
      icon.classList.remove('fa-solid');
      icon.classList.add('fa-regular');
      element.classList.remove('active');
    } else {
      this.favorites.add(productName);
      icon.classList.remove('fa-regular');
      icon.classList.add('fa-solid');
      element.classList.add('active');
    }
    
    localStorage.setItem('favorites', JSON.stringify([...this.favorites]));
    
    // If showing favorites and item was unfavorited, refresh the view
    if (this.showingFavorites && !this.favorites.has(productName)) {
      this.applyFilters(document.getElementById('searchInput').value);
    }
  }
  
  showLoading() {
    document.getElementById('product-grid').innerHTML = '<div class="loading">Loading products...</div>';
  }
  
  showError(message) {
    document.getElementById('product-grid').innerHTML = `<div class="error">${message}<br><br>Check the browser console for more details.</div>`;
  }
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  new ProductGrid();
});
</script>
</body>
</html>
